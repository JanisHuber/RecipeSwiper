<?xml version="1.0" encoding="UTF-8"?>
<server description="RecipeSwiper Server">

    <!-- Enable only needed features for less memory -->
    <featureManager>
        <feature>servlet-6.0</feature>
        <feature>restfulWS-3.1</feature>
        <feature>cdi-4.0</feature>
        <feature>persistence-3.1</feature>
        <feature>persistenceContainer-3.1</feature>
        <feature>jdbc-4.2</feature>
        <feature>beanValidation-3.0</feature>
        <feature>jsonb-3.0</feature>
        <feature>jsonp-2.1</feature>
        <feature>enterpriseBeans-4.0</feature>
        <feature>enterpriseBeansLite-4.0</feature>
    </featureManager>

    <!-- Dynamic port configuration for Render -->
    <variable name="default.http.port" defaultValue="9090"/>
    <variable name="default.https.port" defaultValue="9443"/>

    <!-- HTTP Endpoint with dynamic port from environment -->
    <httpEndpoint id="defaultHttpEndpoint"
                  httpPort="${env.PORT}"
                  httpsPort="${default.https.port}"
                  host="*" />

    <!-- CORS configuration -->
    <httpDispatcher>
        <cors enabled="true"
              domain="*"
              allowCredentials="true"
              allowedMethods="GET,POST,PUT,DELETE,OPTIONS"
              allowedHeaders="*"
              maxAge="3600"/>
    </httpDispatcher>

    <!-- Automatically expand WAR files -->
    <applicationManager autoExpand="true"/>

    <!-- Application configuration -->
    <webApplication contextRoot="/" location="recipeswiper.war">
        <classloader commonLibraryRef="mariadb"/>
    </webApplication>

    <!-- SSL configuration -->
    <ssl id="defaultSSLConfig" trustDefaultCerts="true" />

    <!-- Database configuration -->
    <dataSource id="MariaDBDS" jndiName="jdbc/recipeswiper">
        <jdbcDriver libraryRef="mariadbLib"/>
        <properties
                serverName="recipeswiper-db"
                portNumber="3306"
                databaseName="recipes"
                user="appuser"
                password="apppass" />
    </dataSource>

    <!-- MariaDB library -->
    <library id="mariadb">
        <fileset dir="${shared.resource.dir}/" includes="mariadb-java-client-*.jar"/>
    </library>

    <!-- Logging configuration for production -->
    <logging traceSpecification="*=info" maxFileSize="20" maxFiles="5"/>

</server>
